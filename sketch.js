let levels = [[
    "300000000000000000000000000000000000000000000000000",
    "111111102000000000000000000000000000000000000000000",
    "000000001111111111100200000000000000000000000000000",
    "000000000000000000000111111100000000000000000000000",
    "000000000000000000000000000000200000000000000000000",
    "000000000000000000000000000000111110000000000000000",
    "000000000000000000000000000000000000020000000000000",
    "000000000000000000000000000000000000011111100000000",
    "000000000000000000000000000000000000000000000200000",
    "000000000000000000000000000000000000000000000111110",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000002",
    "000000000000000000000000000000000000000000201111111",
    "000000000000000000000000000000002001111111100000000",
    "000000000000000000000000001111111000000000000000000",
    "000000000000000000000000200000000000000000000000000",
    "000000000000000001111111100000000000000000000000000",
    "000000000000002000000000000000000000000000000000000",
    "000000001111111000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "001111100000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
],[
    "001111111111010000000000000111111111111000000000000",
    "111111111111110000000000000011111111111000000000000",
    "111111111100000000000000000000111111111000000000000",
    "111111111000000000000000000000000000010000000000000",
    "111111111000000000000000000000000000010000000000000",
    "111111110000000000000000000000000011210000000000000",
    "111111112010011000000000000000000111110000000000000",
    "111111111111110000000200000000000111100000000000000",
    "111111111111110000001100000000000001110000000000000",
    "111111111111100000011110000000000000000000000000000",
    "111111111111100000011110000100000000000000000000000",
    "011101111111000000111110000110000000000000000000000",
    "011111110000000000111110001110110000000000000000000",
    "111110000000000010111110001110110000000000000000002",
    "111100000000000010011112011110111100000000000000001",
    "100000000000000000011111111110111111000000000000000",
    "000000000000000000011111111110111111110000000000000",
    "000000000100000000210111111112111111100000000000000",
    "000000001100000000111111111111111111000000000000000",
    "000000001111000000111111111111111111000000000000000",
    "000000000111110000000011111111111111000000010000001",
    "000000002111110000000001111111111110000000112111111",
    "000000001111110000000000001111110100000111111111111",
    "000000001111110000000000201111110100300011101111111",
],[
    "011111111111111111111111111111111111111111111111110",
    "000001000120010000000000002120000000002000012000000",
    "010101010111010111111111011111011111110111011101010",
    "010100010000000120000000010000000000010000200001010",
    "010101110101111111110111110101111111011111111111010",
    "010101210100000000010000000101200001012000000000010",
    "010111010111111111010111111101111101011110110111010",
    "012120010100000001012120000000000001010000000120010",
    "011111010101111101011111111111111111010111110101010",
    "010000000100012001010000010021000000010000210000210",
    "010111111111011101010111010111111111010111011111110",
    "010000010001010100012001010000000001010000000000010",
    "011111010101010101111101010111111101010111111111010",
    "010001010100010100000001000121002101002000000000010",
    "010101010111010111111111011101010101110111111111110",
    "010101012100010000000000010001010101010000000100010",
    "010101011101111111111111010101010101011111010101010",
    "010101000000000100000121010120010001000001210001210",
    "010101011111110101110101010111111111111101111101110",
    "010101012000000100010001010000000000000100000000010",
    "010101011111111111011101011111111111110111111111010",
    "010100000000000000002100000000000000000000000000010",
    "010111111111111111111111111111111111101111111111110",
    "000000000000000000000000300000000000000000000000000",
],[
    "011111111111111111111111111111111111111111111111110",
    "012000000000000000000000000000000000000000000000010",
    "010101010111010111111111011111011111110101010101010",
    "010100010000000000000000012000000000010000000002010",
    "010101010101110111110111110101011111010101010101010",
    "010101010100000000010000000101000001010200000000010",
    "010111010111110111010111111101011101010101010101010",
    "010000010100000001000000000000000001010000000000010",
    "010111010101110101011111111111111111010101010101010",
    "010000002100010001010000010000000000010000000000010",
    "010111111111010101010111010111011111010101010101010",
    "010000010001010100000000000000000001000002000000010",
    "011111010101010101111101010111011101010101010101010",
    "010001010100010100000021000000000001000000000000010",
    "010101010111010111111111011101010101110101010101010",
    "010101010100000000000000010001010100000000000000010",
    "010101010101111111111111010101010101010101010101010",
    "010101000001200000000001010100010001000000000000010",
    "010101011101111111111101010101111111111101111101110",
    "010120000000000100000000010000000000000000000000010",
    "010111111111111101111101011101111111110111111111010",
    "010000000000000000002100000000000000000000000000010",
    "011111111111111111111111011111111111101111111111110",
    "000000000000000000000000300000000000000000000000000",
],[
    "000000000000000000000000000000000000000000000000000",
    "200000000000000000000000000200000000000000000000000",
    "101000000000000000000000011110000020000000000000000",
    "000000000000010000000000000000000111000000000000000",
    "000000000000010000000000000000000000000000000000000",
    "000000000000010000000000000000000001000000000000002",
    "000000000000010200000000000000000000000000000000001",
    "000000000000011111000000000000000001000000000000000",
    "000000000000000000000000000000000001000000000000000",
    "000000000000000000000000000000000001001111000000000",
    "002000000000000000000000011100000000001000000000000",
    "011111100000000000000000000000000011001000002000000",
    "000000000000111100000000000000000001001000111100000",
    "000000000000000000000000000000000001001000000000000",
    "000000000000000000000001111100000000021000000000000",
    "000000000000000000000000000000011111111000000000000",
    "000000000000000000000000000000010000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000200000000000000000000000000000000000000000002000",
    "000110000000000000000111100000000000000000000011100",
    "000000000000000000000000000000000000000000000000000",
    "000000011100000000000000001111000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000003000000000000000000000000",
],[
    "111111111111111111111111111111111111111111111111111",
    "111111111111111111111111111111111111111111111111111",
    "111111111111111111111111111111111111111111111111111",
    "111111111111111111111111111111111111111000011111111",
    "111111111111000111111111111111111110000000001111111",
    "111000000000000011111111110000011000000000001111111",
    "110000000000000011111110000000000000000000021111111",
    "110000000000000011111100000000000000000000011111111",
    "112000000000002111111100000000000000000001111111111",
    "111000000000001111111000000000000000001111111111111",
    "111111110000000011110000000000000200011111111111111",
    "111111111000000001112000000000001111111111000001111",
    "111111100000000000100000000000001001111110000000111",
    "111111000000000000000000000000000000001020000000111",
    "111111000000100000200000000000000000000000000000111",
    "111110000000110000000000000100000000000000000000111",
    "111100000021110000000000001100000000000000002001111",
    "111000000011111000000001111120000000000000001111111",
    "100000000011111100000111111110000000000000001111111",
    "000000000111111110001111111111000000000000001111111",
    "000000001111111111111111111111100300000000011111111",
    "000000011111111111111111111111111111111111111111111",
    "000001111111111111111111111111111111111111111111111",
    "000011111111111111111111111111111111111111111111111",
],[
    "111111111111111111111111111111111111111111111111111",
    "110000000111111111111111111111111111111111111110000",
    "100200000000000000000000000000000111111111000000003",
    "100111110000000000000000000000020011111110000000111",
    "100011111111111111111111111111110011111100001111111",
    "100011111111111111110000000000000011111100111111111",
    "110000111111111100000000000000000011111000111111111",
    "110000000111111000000111111111111111111000111111111",
    "111110000001110000111111111111111111111100011111111",
    "111111102001110001111111111000011111111110000111111",
    "111111111001110011111111000000000011111111000011111",
    "100000000001100011111111000011000001111111112001111",
    "100000000011120011111110001111111200111111111001111",
    "100111111111110001111000011111111100111111111001111",
    "100111111111111001100000111111111100111111111001111",
    "100111111111111000000001111111111100111111110001111",
    "100211111111111000001111111111111000111111110001111",
    "100000011111111111111111111111000001111111100011111",
    "110000001111111111110000000000000011111111000111111",
    "111111001111111111000000000000011111111110001111111",
    "111110001111111100000111111111111111111110001111111",
    "111100011111111000011111111111111111100000011111111",
    "000000111111111000000110000000000000000200111111111",
    "000021111111111120000000000000000000000111111111111",
],[
    "000100010000000000000000010100000000000100000011000",
    "100000000000001001100100001001001000001100000001000",
    "010000000002010001000000001100000000000000000000100",
    "100000000001000002000000001010000000000000002000000",
    "000001000000000001000000000010000000000100001000000",
    "000000000000000000000000100000001001000000110000100",
    "000101010000100010000000000100000002101000000000000",
    "100000000000000000100000010010100101100000000000000",
    "000002000000000000000000011000000000000000100000002",
    "020001000000000101000000200000001001000000000000001",
    "110010000000000010000010100000100000001000000000000",
    "000110000001000000000000000000000000000000000000100",
    "000000000000020000000000200000000000200000000011100",
    "000000000000010000001001110010100010100010000010000",
    "010000100000000000001000000000000000110000000100001",
    "011000001000000000000001000000000010101000000021010",
    "000100000010000000100000000000000000000001001010000",
    "000000000010000000001000000000000100000000010010000",
    "001011000001000001000201000000101000001000001001000",
    "200000001000100000000110001000000000100010101000010",
    "100000000010000000000000000000000000010000000000010",
    "101000000000000001000000001100200000000000000000002",
    "000100000000000010000010000000100000000000000000101",
    "011000000100000002100100030000000000001000000000000",
],[
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000200000000000000000000000000",
    "000000000000000000000111100000000000000000000000000",
    "000000000000000000200000000000000000000000000000000",
    "000000000000000001100000000000000000000000000000000",
    "000000000000000000100000000000000000000000000000000",
    "000000000020002000100000000000000000000000000000000",
    "000000000011011000100000000000000000000000000000000",
    "000000000001010000000000000001000000000000000000000",
    "000000000001010000000000000011000000000000000000000",
    "000000000001210000000000000111000000000000002000000",
    "000000000001110000000000011101000000000000011000000",
    "000000000000000000000000110001000000000000110000000",
    "000000000011011000000000100001000000000001100000000",
    "000000000000200000000000130001111111111111100000000",
    "000000000001110000000000110000000000001102100000000",
    "000000000000100000000000011000000000011000100000000",
    "000000200000100000000000001000000000110000110000000",
    "000001110000100000000000001000000000000000010000000",
    "000000100000100000000000001000000011100000010000000",
    "000000100000100000000011111000001110000000010000000",
    "000000000000000000000012000000001000000000000000000",
],[
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000000000000000000000000000000000000000000000000",
    "000000111111100000000000000000000000000000000000000",
    "000000100000100000000000000000000000000000000000000",
    "000000100000100000000000000101111000000000000000000",
    "000000100000000000000000000100001000000000000000000",
    "000000100111100000000000000100021000000000000000000",
    "000000100000100000000000000101111000000000000000000",
    "000000100000100000000000000100001000000000000000000",
    "000000100000100000000000000100001000000000000000000",
    "000000100111100000000000000101111000000000200000000",
    "000000100000100000000000000100001000000111111111100",
    "000000100000100001111111000100001000000100000000100",
    "000000121000100001000001000101111000000100000003100",
    "000000111100100001200001000100001000000101111111100",
    "000000100000100001100001000102001000000100000000100",
    "000000100000100001110001000101111000000100000000100",
    "000000100000100001111001000100001000000101111111100",
    "000000100111100001000001000100001000000100000000100",
    "000000100000100001000011000101111000000100000000100",
    "000000100000100000000111000100001000000111111110100",
    "000000100002100000001111200120001000200120000000000",
]];
// Globals
let inputNames = ['w','s','a','d'];
let inputStates = [false,false,false,false,false];
let hero;
let map = [];
let tileSize;
let maxLifetime = 60 * 30;
let titleScreen = true;
let gameOver = false;
let level;
let levelNum = 0;
let levelNumMax = 0;
let proc;
let width;
let height;
let swapAxis;
const Directions = {
    NONE : 0,
    LEFT : 1,
    RIGHT : 2
}
const Forces = {
    GRAVITY : 0.1,  // Gravity
    G_FRICT : 0.2,  // Ground friction resistance
    B_FRICT : 0.12, // Reduced friction when a key is held for 1 second
    W_FRICT : 0.2,  // Wall slide resistance
    A_FRICT : 0.1,  // Horizontal air resistance
    V_FRICT : 0.01, // Vertical air resistance
    JUMP_V : 1.3,   // Vertical Jump
    JUMP_H : 3.5,   // Horizontal Jump
    MOVE_A : 0.4    // Reduced horizontal air control
}
const MapElement = {
    NONE : 0,
    WALL : 1,
    COIN : 2,
    EXIT : 3,
    LEVEL : 4
}
class Rect{
    constructor(x1,y1,x2,y2,type,name)
    {
        this.x1 = x1;
        this.y1 = y1;
        this.x2 = x2;
        this.y2 = y2;
        this.type = type;
        this.name = name;
    }
    // none, left, right, top, bottom
    // 0, 1, 2, 3, 4
    collision(x,dx,y,dy,r)
    {
        let tx = x + dx;
        let ty = y + dy;
        if(tx - r < this.x2 && tx + r > this.x1)
        {
            if(ty - r < this.y2 && ty + r > this.y1)
            {
                if(dy > 0 && y+r <= this.y1)
                    return 3;
                if(dy < 0 && y-r >= this.y2)
                    return 4;
                if(dx > 0 && x+r <= this.x1)
                    return 2;
                if(dx < 0 && x-r >= this.x2)
                    return 1;
                return 5;   // Return default if collision isn't moving
            }
        }
        return 0;
    }
    show()
    {
        if(this.type == MapElement.WALL || this.type == MapElement.LEVEL)
        {
            proc.fill(255);
            if(swapAxis) proc.rect(this.y1,this.x1,this.y2-this.y1,this.x2-this.x1);
            else         proc.rect(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1);
        }
        else if(this.type == MapElement.COIN)
        {
            proc.fill(255,255,0,255);
            if(swapAxis) proc.ellipse(this.y1 + (this.y2-this.y1) * 0.5,this.x1 + (this.x2-this.x1) * 0.5,this.y2-this.y1,this.x2-this.x1);
            else         proc.ellipse(this.x1 + (this.x2-this.x1) * 0.5,this.y1 + (this.y2-this.y1) * 0.5,this.x2-this.x1,this.y2-this.y1);
        } else if(this.type == MapElement.EXIT)
        {
            if(hero.points < 10)
            {
                proc.fill(0);
            }
            else
            {
                proc.fill(228,150,200,255);
            }
            if(swapAxis) proc.rect(this.y1,this.x1,this.y2-this.y1,this.x2-this.x1);
            else         proc.rect(this.x1,this.y1,this.x2-this.x1,this.y2-this.y1);
        }
        if(this.type == MapElement.LEVEL)
        {
            proc.fill(150);
            //textAlign(CENTER,CENTER);
            //textSize((this.x2 - this.x1)*0.5);
            //text(this.name,this.x1 + (this.x2-this.x1)*0.5 ,this.y1 + (this.y2-this.y1) * 0.5);
        }
    }
}
class Hero{
    constructor()
    {
        this.x = 500;
        this.y = 500;
        this.dx = 1;
        this.dy = 1;
        this.directionHeld = Directions.NONE;
        this.timeHeld = 0;
        this.airtime = 0;
        this.wallslide = Directions.NONE;
        this.wallBottom = 0;
        this.pd = 2;
        this.r = 5;
        this.points = 0;
        this.lifetime = maxLifetime;
        this.win = false;
    }
    recalcRadius()
    {
        this.r = this.pd * 4;
        this.y = height - this.r;
        this.x = 0 + this.r;
    }
    show()
    {
        proc.fill(228,150,200);
        if(swapAxis) proc.rect(0,0,tileSize * 0.5, (this.lifetime/maxLifetime) * width);
        else         proc.rect(0,0,(this.lifetime/maxLifetime) * width, tileSize * 0.5);
        proc.fill(200);
        //textAlign(CENTER);
        //textSize(tileSize * 0.5);
        //text(Math.round((this.lifetime / 60),2)+"s",width/2,tileSize * 0.4);
        if(this.lifetime == 0)
        {
            proc.fill(255,0,0);
            //textAlign(CENTER);
            //textSize(tileSize);
            //text("You Died",width/2,height/2);
            //text("Touch or Escape to Exit",width/2,height/2 + 40);
            gameOver = true;
        }
        if(this.points == 30 && this.win)
        {
            //textSize(tileSize);
            //textAlign(CENTER);
            //text("You're The Coolest Bean", width/2, height/2);
        }
        else if(this.points >= 10 && this.win)
        {
            //fill('#e496c8');
            //textSize(tileSize);
            //textAlign(CENTER);
            //text("You Win!!!", width/2, height/2);
        }
        //text('x: ' + Math.round(this.x,2) + ' y: ' + Math.round(this.y,2), 5,10);
        //text('dx: ' + Math.round(this.dx,2) + ' dy: ' + Math.round(this.dy,2), 5,20);
        //text('airtime: '+this.airtime, 5, 30);
        //text('wallslide: '+this.wallslide, 5, 40);
        //text('points: '+this.points, 5, 50);
        if(swapAxis) proc.ellipse(this.y,this.x,this.r*2,this.r*2);
        else         proc.ellipse(this.x,this.y,this.r*2,this.r*2);
    }
    addGravity()
    {
        if(this.lifetime > 0 && this.win == false)
        {
            this.lifetime--;
        }
        else
        {
            this.wallslide = Directions.NONE;
        }
        if(this.y > this.wallBottom)
        {
            this.wallslide = Directions.NONE;
        }
        this.addForce(0,this.pd * Forces.GRAVITY);
    }
    jump()
    {
        if(this.airtime < 8 && this.airtime % 3 == 0)
        {
            if(this.wallslide == Directions.RIGHT)
            {
                this.dy = 0;
                this.addForce(-Forces.JUMP_H*this.pd,0);
                this.wallslide = Directions.NONE;      
            }else if(this.wallslide == Directions.LEFT)
            {
                this.dy = 0;
                this.addForce(Forces.JUMP_H*this.pd,0);
                this.wallslide = Directions.NONE;      
            }
            this.addForce(0,-Forces.JUMP_V*this.pd);
        }
    }
    left()
    {
        if(this.wallslide == Directions.RIGHT)
        {
            this.wallslide = Directions.NONE;
        }
        if(this.airtime == 0)
        {
            this.addForce(-this.pd,0);
        }
        else
        {
            this.addForce(-Forces.MOVE_A*this.pd,0);
        }
    }
    right()
    {
        if(this.wallslide == Directions.LEFT)
        {
            this.wallslide = Directions.NONE;
        }    
        if(this.airtime == 0)
        {
            this.addForce(this.pd,0);
        }
        else
        {
            this.addForce(Forces.MOVE_A*this.pd,0);
        }
    }
    addForce(dx,dy)
    {
        this.dx += dx;
        this.dy += dy;
    }
    applyFriction()
    {
        if(this.timeHeld > 60)
        {
            this.dx -= Forces.B_FRICT*this.dx;
        }
        else
        {
            if(this.airtime == 0)
            {
                this.dx -= Forces.G_FRICT*this.dx;
            }
            else
            {
                this.dx -= Forces.A_FRICT*this.dx;
            }
        }
        if(this.wallslide)
        {
            this.dy -= Forces.W_FRICT*this.dy;
        }
        else
        {
            this.dy -= Forces.V_FRICT*this.dy;
        }
    }
    tryMovePlayer()
    {
        let colX = false;
        let colY = false;
        for(let i=0;i<map.length;i++)
        {
            if(map[i].type == MapElement.COIN)
            {
                if(map[i].collision(this.x,this.dx,this.y,this.dy,this.r))
                {
                    this.points++;
                    this.lifetime += 60 * 5;
                    if(this.lifetime > maxLifetime)
                    {
                        maxLifetime = this.lifetime;
                    }
                    map.splice(i,1);
                    i--;
                }
            }
            if(map[i].type == MapElement.EXIT)
            {
                if(map[i].collision(this.x,this.dx,this.y,this.dy,this.r))
                {
                    if(this.points >= 10)
                    {
                        if(this.win == false)
                        {
                            if(levelNum == levelNumMax-1)
                            {
                                levelNumMax++;
                            }
                            //localStorage && (localStorage.levelNumMax = levelNumMax);
                        }
                        this.win = true;
                    }
                }
            }
            if(map[i].type == MapElement.WALL)
            {
                // Vertical collision
                switch(map[i].collision(this.x,this.dx,this.y,this.dy,this.r))
                {
                    case 3:
                    {
                        colY = true;
                        this.airtime = 0;
                        this.dy = 0;
                        this.y = map[i].y1 - this.r;
                    }break;
                    case 4:
                    {
                        colY = true;
                        this.airtime++;
                        this.dy = 0;
                        this.y = map[i].y2 + this.r;
                    }break;
                }
                // Horizontal and diagonal collision
                switch(map[i].collision(this.x,this.dx,this.y,0,this.r))
                {
                    case 1:
                    {
                        if(this.timeHeld > 3)
                        {
                            this.wallslide = Directions.LEFT;
                            this.wallBottom = map[i].y2;
                            this.airtime = 0;
                            this.timeHeld = 0;
                        }
                        colX = true;
                        this.dx = 0;
                        this.x = map[i].x2 + this.r;
                    }break;
                    case 2:
                    {
                        if(this.timeHeld > 3)
                        {
                            this.wallslide = Directions.RIGHT;
                            this.wallBottom = map[i].y2;
                            this.airtime = 0;
                            this.timeHeld = 0;
                        }
                        colX = true;
                        this.dx = 0;
                        this.x = map[i].x1 - this.r;
                    }break;
                }
            }
        }
        if(!colX)
        {
            if(this.y > this.wallBottom)
            {
                this.wallslide = Directions.NONE;
            }
            this.x += this.dx;
        }
        if(!colY)
        {
            this.y += this.dy;
            if(this.wallslide == Directions.NONE)
            {
                this.airtime++;
            }   
        }
            
    }
}
function startNewTitleScreen()
{
    proc.size(width, height);    
    proc.background(0);
    let i = 0;
    let offX = width/40;
    let offY = height/2;
    for(let y=0; y<3; y++)
    {
        for(let x=0; x<20; x++)
        {
            if(x % 2 == 0 && y % 2 == 0)
            {
                if(i < levelNumMax && i < levels.length)
                {
                    i++;
                    map.push(new Rect(x*(width/20) + offX,y*(width/20) + offY,(x+1)*(width/20) + offX,(y+1)*(width/20) + offY,MapElement.LEVEL,i+""));
                }
            }
        }
    }
}

export function startNewGame()
{
    level = levels[levelNum];
    let rows = level.length;
    let cols = level[0].length;
    tileSize = width / cols;

    proc.size(width, tileSize * rows);    
    proc.background(0);
    map = new Array(
    new Rect(-100, height, width + 100, height + 100,1),  // Floor
    new Rect(-100, -10, 0, height + 10,1),                // Left
    new Rect(width, -10, width + 100, height + 10,1),     // Right
    new Rect(-100, -100, width + 100, 0,1)                // Roof
    ); 
    
    hero = new Hero();
    hero.pd = tileSize/20;
    hero.recalcRadius();
    hero.x = 0;
    hero.y = 24*tileSize;
    
    let yOff = tileSize*1.5;
    let unconnected = new Array(rows*cols).fill(true);
    let startRow = -1;
    let startCol = -1;
    for(let col = 0; col < cols;col++) {
        for(let row = 0; row < rows;row++) {
            if(level[row][col] == '1') {
                startRow = row;
                startCol = col;
                if(row-1 < 0 || row==rows-1 || level[row-1][col] != '1') {
                    for(let j=row; j<rows+1; j++) {
                        if(j==rows || level[j][col] != '1') {
                            if(j - startRow > 1) {
                                if(j<rows) row = j;
                                else row = rows-1;
                                map.push(new Rect(startCol*tileSize,startRow*tileSize+yOff,(col+1)*tileSize,(j)*tileSize+yOff,MapElement.WALL));
                            }
                            break;
                        }
                    }
                }
                startRow = row;
                if(unconnected[row*rows+(col-1)]) {
                    for(let i=col;i<cols+1;i++) {
                        if(i==cols || level[row][i] != '1') {
                            if(i - startCol > 1 || row-1 >= 0 && level[row][col+1] != '1' && level[row-1][col] != '1')
                                map.push(new Rect(startCol*tileSize,startRow*tileSize+yOff,(i)*tileSize,(row+1)*tileSize+yOff,MapElement.WALL));
                            break;
                        }
                        else
                            unconnected[row*rows+i] = false;
                    }
                }
                startRow = -1;
                startCol = -1;
            }
            if(level[row][col] == '2')
                map.push(new Rect(col*tileSize + tileSize/3,row*tileSize + tileSize/3+yOff,(col+1)*tileSize - tileSize/3,(row+1)*tileSize - tileSize/3+yOff,MapElement.COIN));
            if(level[row][col] == '3')
                map.push(new Rect(col*tileSize,row*tileSize + tileSize/2+yOff,(col+1)*tileSize,(row+1)*tileSize+yOff,MapElement.EXIT));
        }
        if(startCol > 0 && startRow > 0)
            map.push(new Rect(startCol*tileSize,startRow*tileSize+yOff,(col+1)*tileSize,rows*tileSize+yOff,MapElement.WALL));
        startRow = -1;
        startCol = -1;
    }
    // 51 * 24 sized levels
    map.push(new Rect(0,24*tileSize+yOff,51*tileSize,25*tileSize+yOff,MapElement.WALL));
}

function gameUpdate()
{
    if(gameOver || hero.win)
    {
        titleScreen = true;
        map = [];
        startNewTitleScreen();
    }
    // Player input
    if(hero.lifetime > 0)
    {
        if(inputStates[0] || inputStates[4])
        {
            hero.jump();
        }
        else if(inputStates[1])
        {
            
        }
        if(inputStates[2] && !inputStates[3])
        {
            if(hero.directionHeld == Directions.LEFT)
            {
                hero.timeHeld++;
            }
            else{
                hero.directionHeld = Directions.LEFT;
                hero.timeHeld = 0;
            }
            hero.left();
        }
        else if(inputStates[3] && !inputStates[2])
        {
            if(hero.directionHeld == Directions.RIGHT)
            {
                hero.timeHeld++;
            }
            else{
                hero.directionHeld = Directions.RIGHT;
                hero.timeHeld = 0;
            }
            hero.right();
        }
        else
        {
            hero.directionHeld = Directions.NONE;
            hero.timeHeld = 0;
        }
    }
    
    // Map setup
    for(let i=0;i<map.length;i++)
    {
        map[i].show();
    }
    
    hero.applyFriction();
    hero.addGravity();
    hero.tryMovePlayer();
    hero.show();
}
export function setup(p, w, h, a) {
    proc = p;
    width = w;
    height = h;
    swapAxis = a;
    /*
    if (localStorage && 'levelNumMax' in localStorage) {
        levelNumMax = Number(localStorage.levelNumMax);
        if(levelNumMax > levels.length)
        {
            levelNum = levelNumMax-2;
        }
        else
        {
            levelNum = levelNumMax - 1;
        }
    }
    else
    {
        levelNumMax = 1;
        localStorage && (localStorage.levelNumMax = levelNumMax);
        levelNum = levelNumMax - 1;
    }
    */
    levelNumMax = 10;
    //startNewTitleScreen();    
    titleScreen = false;
}

export function draw() {
    proc.background(0);
    proc.noStroke();
    if(titleScreen)
    {
        //proc.fill(200);
        //textAlign(CENTER);
        //textSize(windowWidth*0.05);
        //text("Ninja Game", width/2,height/4);
        //text("Press any key to start", width/2,height/4 + windowWidth*0.05);
    }
    else
    {
        gameUpdate();
    }
}
//let inputNames = ['w','s','a','d'];
//let inputStates = [false,false,false,false,false];
export function touch(x,y){
    if(x < width/3) {
        inputStates[2] = true;
    }
    else if(x > width*2/3) {
        inputStates[3] = true;
    }
    if(y < height/2) {
        inputStates[0] = true;
    }
}
export function untouch(){
    for(let i=0;i<inputStates.length;i++){
        inputStates[i] = false;
    }
}